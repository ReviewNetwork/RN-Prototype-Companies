"use strict";var Crypto=require("crypto"),EC=require("elliptic").ec,ec=new EC("secp256k1"),Buffer=require("safe-buffer").Buffer,AES256CbcEncrypt=function(e,r,t){var c=Crypto.createCipheriv("aes-256-cbc",r,e),a=c.update(t),i=c.final();return Buffer.concat([a,i])},AES256CbcDecrypt=function(e,r,t){var c=Crypto.createDecipheriv("aes-256-cbc",r,e),a=c.update(t),i=c.final();return Buffer.concat([a,i])},BufferEqual=function(e,r){if(e.length!==r.length)return!1;for(var t=0,c=0;c<e.length;c++)t|=e[c]^r[c];return 0===t},Encrypt=function(e,r,t){t=t||{};var c=ec.keyFromPrivate(t.ephemPrivKey||Crypto.randomBytes(32)),a=c.getPublic(),i=Buffer.from(a.encode()),u=c.derive(ec.keyFromPublic(Buffer.concat([Buffer.from([4]),e])).getPublic()),f=Crypto.createHash("sha512").update(u.toArrayLike(Buffer)).digest(),n=t.iv||Crypto.randomBytes(16),o=f.slice(0,32),p=f.slice(32),y=AES256CbcEncrypt(n,o,r),s=Buffer.concat([n,i,y]),l=Crypto.createHmac("sha256",p).update(s).digest();return Buffer.concat([n,i,l,y])},Decrypt=function(e,r){var t=r.slice(0,16),c=r.slice(16,81),a=r.slice(81,113),i=r.slice(113),u=ec.keyFromPublic(c).getPublic(),f=ec.keyFromPrivate(e).derive(u),n=Crypto.createHash("sha512").update(f.toArrayLike(Buffer)).digest(),o=n.slice(0,32),p=n.slice(32),y=Buffer.concat([t,c,i]),s=Crypto.createHmac("sha256",p).update(y).digest();if(!BufferEqual(s,a))throw new Error("MAC mismatch");return AES256CbcDecrypt(t,o,i)};module.exports={encrypt:Encrypt,decrypt:Decrypt};